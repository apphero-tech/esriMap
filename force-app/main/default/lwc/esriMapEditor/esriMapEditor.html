<template>
    <div class="esri-map-container">
        <div class="page-header">
            <h1 class="page-title">{pageTitle}</h1>
        </div>

        <!-- Carte -->
        <div class="map-card slds-card">
            <div class="slds-card__body slds-card__body_inner">
                <div class="map-container">
                    <iframe 
                        src={vfPageUrl} 
                        title="Carte ArcGIS"
                        class="map-iframe"
                        onload={onMapReady}
                        sandbox="allow-scripts allow-same-origin allow-forms allow-modals"
                        allow="geolocation *">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- Boutons principaux centrés -->
        <template if:false={readOnly}>
            <div class="primary-buttons buttons-section slds-text-align_center">
                <lightning-button 
                    variant="brand" 
                    label={saveButtonLabel}
                    title="Enregistrer la forme actuellement sélectionnée sur la carte"
                    disabled={isSaveButtonDisabled}
                    onclick={handleSaveShape}
                    class="btn-primary">
                </lightning-button>
                <lightning-button 
                    label="Annuler"
                    variant="neutral"
                    onclick={handleCancel}
                    class="btn-secondary">
                </lightning-button>
            </div>
        </template>

        <!-- Message d'erreur -->
        <template if:true={errorMessage}>
            <div class="slds-notify slds-notify_alert slds-alert_error slds-m-top_medium" role="alert">
                <span class="slds-assistive-text">error</span>
                <svg class="slds-icon slds-icon_small slds-m-right_small" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <span class="slds-m-left_small">{errorMessage}</span>
            </div>
        </template>

        <!-- Liste des enregistrements créés/liés -->
        <div class="enregistrements-section records-card content-section">
            <div class="section-header section-title">
                <template if:true={isLoadingRelated}>
                    <lightning-spinner alternative-text="Chargement des zones liées..."></lightning-spinner>
                </template>
                <template if:false={isLoadingRelated}>
                    <template if:true={readOnly}>
                        Enregistrements liés
                    </template>
                    <template if:false={readOnly}>
                        Enregistrements créés
                    </template>
                </template>
            </div>
            <!-- En-têtes -->
            <div class="records-table table-header-row">
                <div class="table-header">Nom</div>
                <div class="table-header">Adresse</div>
                <div class="table-header desktop-only">Latitude</div>
                <div class="table-header desktop-only">Longitude</div>
                <div class="table-header">Type</div>
                <div class="table-header desktop-only">Créé par</div>
                <div class="table-header desktop-only">Date de création</div>
                <div class="table-header">Actions</div>
            </div>
            <!-- Lignes -->
            <template for:each={tableRows} for:item="rec">
                <div key={rec.id} class="records-table">
                    <div class="table-cell"><a href={rec.url} target="_blank">{rec.name}</a></div>
                    <div class="table-cell">{rec.address}</div>
                    <div class="table-cell desktop-only">{rec.latitude}</div>
                    <div class="table-cell desktop-only">{rec.longitude}</div>
                    <div class="table-cell"><span class="type-badge">{rec.type}</span></div>
                    <div class="table-cell desktop-only">{rec.createdByName}</div>
                    <div class="table-cell desktop-only">{rec.createdDate}</div>
                    <div class="table-cell">
                        <button class="table-action-button" data-id={rec.id} onclick={handleViewOnMap}>Voir sur la carte</button>
                    </div>
                </div>
            </template>
            <template if:false={hasCreatedRecords}>
                <div class="slds-p-around_medium slds-text-align_center slds-text-color_weak">
                    <template if:true={readOnly}>
                        Aucune zone liée pour l'instant.
                    </template>
                    <template if:false={readOnly}>
                        Aucun enregistrement pour l'instant.
                    </template>
                </div>
            </template>
        </div>
    </div>
</template>